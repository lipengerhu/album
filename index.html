<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>照片上传</title>
    <style>
        /* 样式保持不变 */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML结构保持不变 -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/spark-md5@3.0.2/spark-md5.min.js"></script>
    <!-- 添加 EXIF.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script>
        // 配置信息 - 串行上传
        const CONFIG = {
            CLOUD_FUNCTION_URL: 'https://cloud1-4g2pwcs3890409d1-1359729503.ap-shanghai.app.tcloudbase.com/album',
            MAX_FILES: 50,
            CHUNK_SIZE: 50 * 1024,
            MAX_RETRIES: 3
        };

        // 状态管理
        let selectedFiles = [];
        let uploadInProgress = false;
        let currentUploadController = null;
        let currentUploadIndex = 0;

        // DOM元素
        const elements = {
            fileInput: document.getElementById('file-input'),
            uploadArea: document.getElementById('upload-area'),
            fileList: document.getElementById('file-list'),
            emptyState: document.getElementById('empty-state'),
            startUpload: document.getElementById('start-upload'),
            clearFiles: document.getElementById('clear-files'),
            resultInfo: document.getElementById('result-info'),
            resultContent: document.getElementById('result-content'),
            serviceStatus: document.getElementById('service-status'),
            totalFiles: document.getElementById('total-files'),
            withAddress: document.getElementById('with-address'),
            totalSize: document.getElementById('total-size')
        };

        // 初始化函数
        function init() {
            initEventListeners();
            checkServiceStatus();
        }

        function initEventListeners() {
            elements.uploadArea.addEventListener('click', function() {
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', function(e) {
                handleFileSelect(e);
            });

            elements.startUpload.addEventListener('click', function() {
                if (!elements.startUpload.disabled && !uploadInProgress) {
                    startUpload();
                }
            });

            elements.clearFiles.addEventListener('click', function() {
                clearFiles();
            });

            setupDragAndDrop();
        }

        // 文件选择处理
        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            let validFilesAdded = 0;
            
            for (const file of files) {
                const existingFile = selectedFiles.find(f => 
                    f.file.name === file.name && f.file.size === file.size
                );
                
                if (!existingFile && selectedFiles.length < CONFIG.MAX_FILES) {
                    // 提取照片信息
                    const fileInfo = await extractFileInfo(file);
                    
                    selectedFiles.push({
                        file: file,
                        status: 'pending',
                        progress: 0,
                        fingerprint: null,
                        fileId: null,
                        error: null,
                        fileInfo: fileInfo
                    });
                    validFilesAdded++;
                }
            }
            
            if (validFilesAdded > 0) {
                updateFileList();
                updateUploadButton();
                updateStats();
            }
            
            elements.fileInput.value = '';
        }

        // 提取照片信息 - 修复语法错误
        async function extractFileInfo(file) {
            return new Promise((resolve) => {
                // 方法1: 使用EXIF.js
                EXIF.getData(file, function() {
                    try {
                        console.log('开始提取文件信息:', file.name);
                        
                        // 获取所有EXIF数据
                        const allExifData = EXIF.getAllTags(this);
                        console.log('完整EXIF数据:', allExifData);
                        
                        // 特别检查GPS相关标签
                        const gpsTags = {};
                        Object.keys(allExifData).forEach(key => {
                            if (key.includes('GPS') || key.includes('gps')) {
                                gpsTags[key] = allExifData[key];
                            }
                        });
                        console.log('GPS相关标签:', gpsTags);
                        
                        // 提取GPS信息
                        const gpsInfo = extractGPSInfo(allExifData);
                        
                        // 提取时间信息
                        const timeInfo = extractTimeInfo(allExifData, file);
                        
                        // 如果EXIF.js没有提取到GPS，尝试其他方法
                        if (!gpsInfo.hasGPS) {
                            console.log('EXIF.js未提取到GPS，尝试其他方法...');
                            // 使用Promise来处理异步操作
                            tryAlternativeGPSMethods(file).then(alternativeGPS => {
                                if (alternativeGPS.hasGPS) {
                                    Object.assign(gpsInfo, alternativeGPS);
                                }
                                console.log('最终GPS信息:', gpsInfo);
                                
                                resolve({
                                    ...gpsInfo,
                                    ...timeInfo,
                                    rawExif: allExifData
                                });
                            }).catch(() => {
                                console.log('最终GPS信息:', gpsInfo);
                                resolve({
                                    ...gpsInfo,
                                    ...timeInfo,
                                    rawExif: allExifData
                                });
                            });
                        } else {
                            console.log('最终GPS信息:', gpsInfo);
                            resolve({
                                ...gpsInfo,
                                ...timeInfo,
                                rawExif: allExifData
                            });
                        }
                    } catch (error) {
                        console.error('提取EXIF信息失败:', error);
                        // 如果EXIF提取失败，尝试其他方法
                        tryAlternativeGPSMethods(file).then(alternativeResult => {
                            resolve({
                                ...alternativeResult,
                                earliestTime: null,
                                hasTime: false
                            });
                        }).catch(() => {
                            resolve({
                                hasGPS: false,
                                latitude: null,
                                longitude: null,
                                earliestTime: null,
                                hasTime: false
                            });
                        });
                    }
                });
            });
        }

        // 尝试其他GPS提取方法
        function tryAlternativeGPSMethods(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        // 方法2: 尝试从二进制数据中查找GPS信息
                        const arrayBuffer = e.target.result;
                        const gpsInfo = findGPSInBinary(arrayBuffer);
                        
                        if (gpsInfo.hasGPS) {
                            console.log('从二进制数据中找到GPS信息');
                            resolve(gpsInfo);
                        } else {
                            // 方法3: 尝试使用DataView读取
                            const dataViewGPS = parseGPSWithDataView(arrayBuffer);
                            if (dataViewGPS.hasGPS) {
                                console.log('使用DataView找到GPS信息');
                                resolve(dataViewGPS);
                            } else {
                                resolve({
                                    hasGPS: false,
                                    latitude: null,
                                    longitude: null
                                });
                            }
                        }
                    } catch (error) {
                        console.error('其他GPS提取方法失败:', error);
                        resolve({
                            hasGPS: false,
                            latitude: null,
                            longitude: null
                        });
                    }
                };
                
                reader.onerror = function() {
                    resolve({
                        hasGPS: false,
                        latitude: null,
                        longitude: null
                    });
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // 从二进制数据中查找GPS信息
        function findGPSInBinary(arrayBuffer) {
            try {
                const uint8Array = new Uint8Array(arrayBuffer);
                const decoder = new TextDecoder('utf-8');
                const text = decoder.decode(uint8Array);
                
                // 查找常见的GPS标记
                if (text.includes('GPS') || text.includes('gps')) {
                    console.log('在二进制数据中找到GPS标记');
                    // 这里可以添加更复杂的GPS数据解析逻辑
                }
                
                return {
                    hasGPS: false,
                    latitude: null,
                    longitude: null
                };
            } catch (error) {
                return {
                    hasGPS: false,
                    latitude: null,
                    longitude: null
                };
            }
        }

        // 使用DataView解析GPS
        function parseGPSWithDataView(arrayBuffer) {
            try {
                const dataView = new DataView(arrayBuffer);
                
                // 查找EXIF头 (0xFF 0xE1)
                for (let i = 0; i < arrayBuffer.byteLength - 4; i++) {
                    if (dataView.getUint16(i) === 0xFFE1) {
                        console.log('找到EXIF段');
                        // 这里可以添加EXIF段解析逻辑
                    }
                }
                
                return {
                    hasGPS: false,
                    latitude: null,
                    longitude: null
                };
            } catch (error) {
                return {
                    hasGPS: false,
                    latitude: null,
                    longitude: null
                };
            }
        }

        // 提取GPS信息 - 增强版本
        function extractGPSInfo(exifData) {
            const gpsInfo = {
                hasGPS: false,
                latitude: null,
                longitude: null,
                rawGPS: null,
                debug: {}
            };
            
            // 记录所有GPS相关标签用于调试
            Object.keys(exifData).forEach(key => {
                if (key.toUpperCase().includes('GPS')) {
                    gpsInfo.debug[key] = exifData[key];
                }
            });
            
            console.log('GPS调试信息:', gpsInfo.debug);
            
            // 检查是否存在GPS数据 - 多种可能的标签名称
            const gpsLatitude = exifData.GPSLatitude || exifData.gpsLatitude;
            const gpsLongitude = exifData.GPSLongitude || exifData.gpsLongitude;
            const gpsLatitudeRef = exifData.GPSLatitudeRef || exifData.gpsLatitudeRef;
            const gpsLongitudeRef = exifData.GPSLongitudeRef || exifData.gpsLongitudeRef;
            
            if (gpsLatitude && gpsLongitude) {
                console.log('找到GPS坐标:', {
                    latitude: gpsLatitude,
                    longitude: gpsLongitude,
                    latRef: gpsLatitudeRef,
                    longRef: gpsLongitudeRef
                });
                
                gpsInfo.hasGPS = true;
                gpsInfo.rawGPS = {
                    latitude: gpsLatitude,
                    longitude: gpsLongitude,
                    latitudeRef: gpsLatitudeRef,
                    longitudeRef: gpsLongitudeRef
                };
                
                // 转换GPS坐标为十进制
                gpsInfo.latitude = convertGPSCoordinate(gpsLatitude, gpsLatitudeRef);
                gpsInfo.longitude = convertGPSCoordinate(gpsLongitude, gpsLongitudeRef);
                
                console.log('转换后的GPS坐标:', {
                    latitude: gpsInfo.latitude,
                    longitude: gpsInfo.longitude
                });
            } else {
                console.log('未找到GPS坐标数据');
                // 检查是否有其他格式的GPS数据
                if (exifData.GPSInfo) {
                    console.log('找到GPSInfo:', exifData.GPSInfo);
                }
                if (exifData.gps) {
                    console.log('找到gps:', exifData.gps);
                }
            }
            
            return gpsInfo;
        }

        // 转换GPS坐标为十进制 - 增强版本
        function convertGPSCoordinate(coord, ref) {
            if (!coord) {
                console.log('坐标数据为空');
                return null;
            }
            
            try {
                console.log('转换坐标:', coord, '参考:', ref);
                
                // 处理不同的坐标格式
                let degrees, minutes, seconds;
                
                if (Array.isArray(coord)) {
                    // 格式: [度, 分, 秒]
                    if (coord.length >= 3) {
                        degrees = coord[0];
                        minutes = coord[1];
                        seconds = coord[2];
                    } else {
                        console.log('坐标数组长度不足:', coord.length);
                        return null;
                    }
                } else if (typeof coord === 'string') {
                    // 格式: "36;48;28.98"
                    const parts = coord.split(';');
                    if (parts.length >= 3) {
                        degrees = parseFloat(parts[0]);
                        minutes = parseFloat(parts[1]);
                        seconds = parseFloat(parts[2]);
                    } else {
                        console.log('坐标字符串格式错误:', coord);
                        return null;
                    }
                } else if (typeof coord === 'number') {
                    // 直接是十进制数字
                    let decimal = coord;
                    if (ref === 'S' || ref === 'W') {
                        decimal = -decimal;
                    }
                    return decimal;
                } else {
                    console.log('未知坐标格式:', typeof coord, coord);
                    return null;
                }
                
                // 确保值是数字
                degrees = typeof degrees === 'number' ? degrees : parseFloat(degrees);
                minutes = typeof minutes === 'number' ? minutes : parseFloat(minutes);
                seconds = typeof seconds === 'number' ? seconds : parseFloat(seconds);
                
                if (isNaN(degrees) || isNaN(minutes) || isNaN(seconds)) {
                    console.log('坐标值包含非数字:', degrees, minutes, seconds);
                    return null;
                }
                
                // 转换为十进制
                let decimal = degrees + minutes / 60 + seconds / 3600;
                
                // 根据参考方向调整正负
                if (ref === 'S' || ref === 'W') {
                    decimal = -decimal;
                }
                
                console.log('坐标转换结果:', decimal);
                return decimal;
                
            } catch (error) {
                console.error('GPS坐标转换失败:', error, '坐标:', coord, '参考:', ref);
                return null;
            }
        }

        // 提取时间信息
        function extractTimeInfo(exifData, file) {
            const times = {};
            
            // EXIF拍摄时间（最准确）
            if (exifData.DateTimeOriginal) {
                times.exifTime = parseEXIFDate(exifData.DateTimeOriginal);
            }
            
            // EXIF创建时间
            if (exifData.DateTime) {
                times.exifCreateTime = parseEXIFDate(exifData.DateTime);
            }
            
            // 文件修改时间
            if (file.lastModified) {
                times.lastModified = new Date(file.lastModified).toISOString();
            }
            
            // 选择最早的时间
            const earliestTime = getEarliestTime(times);
            
            return {
                earliestTime: earliestTime,
                hasTime: !!earliestTime,
                rawTimes: times
            };
        }

        // 解析EXIF日期格式
        function parseEXIFDate(dateString) {
            try {
                // EXIF日期格式: "YYYY:MM:DD HH:MM:SS"
                const parts = dateString.split(' ');
                const datePart = parts[0].replace(/:/g, '-');
                const timePart = parts[1];
                const result = new Date(datePart + 'T' + timePart).toISOString();
                console.log('解析EXIF日期:', dateString, '->', result);
                return result;
            } catch (error) {
                console.error('解析EXIF日期失败:', error, '日期字符串:', dateString);
                return null;
            }
        }

        // 从多个时间中选择最早的一个
        function getEarliestTime(timeObj) {
            const validTimes = Object.values(timeObj).filter(time => time && time !== 'Invalid Date');
            
            if (validTimes.length === 0) {
                return null;
            }
            
            // 将时间字符串转换为Date对象进行比较
            const timeDates = validTimes.map(time => new Date(time));
            
            // 找到最早的时间
            const earliestDate = timeDates.reduce((earliest, current) => {
                return current < earliest ? current : earliest;
            });
            
            return earliestDate.toISOString();
        }

        // 更新文件列表 - 显示详细的GPS信息
        function updateFileList() {
            // 只显示未取消的文件
            const visibleFiles = selectedFiles.filter(f => f.status !== 'cancelled');
            
            if (visibleFiles.length === 0) {
                elements.fileList.innerHTML = '<div class="empty-state">暂无照片</div>';
                elements.emptyState.style.display = 'block';
                return;
            }
            
            elements.emptyState.style.display = 'none';
            
            elements.fileList.innerHTML = visibleFiles.map((fileData) => {
                const errorInfo = fileData.error ? 
                    `<div style="color: #dc3545; font-size: 12px; margin-top: 6px;">错误: ${fileData.error}</div>` : '';
                
                // 时间信息显示
                const timeInfo = fileData.fileInfo.hasTime ? 
                    `<div class="file-meta">📅 ${new Date(fileData.fileInfo.earliestTime).toLocaleDateString()}</div>` : 
                    `<div class="file-meta">⏰ 无时间信息</div>`;
                
                // GPS信息显示 - 更详细
                let gpsInfo = '';
                if (fileData.fileInfo.hasGPS) {
                    if (fileData.fileInfo.latitude && fileData.fileInfo.longitude) {
                        gpsInfo = `<div class="file-meta">📍 GPS: ${fileData.fileInfo.latitude.toFixed(6)}, ${fileData.fileInfo.longitude.toFixed(6)}</div>`;
                    } else {
                        gpsInfo = `<div class="file-meta">📍 有GPS数据但无法解析</div>`;
                    }
                } else {
                    gpsInfo = `<div class="file-meta">📍 无GPS信息</div>`;
                }
                
                // 文件大小
                const sizeInfo = `<div class="file-meta">📦 ${formatFileSize(fileData.file.size)}</div>`;
                
                // 取消按钮
                const cancelButton = (fileData.status === 'uploading' || fileData.status === 'pending') ? 
                    `<button class="cancel-btn" data-filename="${fileData.file.name}" title="取消上传">❌</button>` : '';
                
                // 进度条
                const progressBar = (fileData.status === 'uploading' || fileData.status === 'pending') ? 
                    `<div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${fileData.progress}%"></div>
                        </div>
                        <div class="progress-text">${fileData.progress}%</div>
                    </div>` : '';
                
                return `
                <div class="file-item">
                    <div class="file-icon">🖼️</div>
                    <div class="file-info">
                        <div class="file-name">${fileData.file.name}</div>
                        ${timeInfo}
                        ${gpsInfo}
                        ${sizeInfo}
                        ${errorInfo}
                        ${progressBar}
                    </div>
                    <div class="file-actions">
                        <div class="file-status status-${fileData.status}">
                            ${getStatusText(fileData.status)}
                        </div>
                        ${cancelButton}
                    </div>
                </div>
                `;
            }).join('');
            
            attachCancelButtonListeners();
        }

        // 其余函数保持不变...
        // 更新统计信息 - 修改：不统计已取消的文件
        function updateStats() {
            const visibleFiles = selectedFiles.filter(f => f.status !== 'cancelled');
            elements.totalFiles.textContent = visibleFiles.length;
            
            const withAddressCount = visibleFiles.filter(f => f.fileInfo.hasGPS).length;
            elements.withAddress.textContent = withAddressCount;
            
            const totalBytes = visibleFiles.reduce((sum, fileData) => sum + fileData.file.size, 0);
            elements.totalSize.textContent = (totalBytes / 1024 / 1024).toFixed(1) + 'MB';
        }

        // 添加取消按钮事件监听
        function attachCancelButtonListeners() {
            document.querySelectorAll('.cancel-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    const fileName = this.getAttribute('data-filename');
                    cancelFileUpload(fileName);
                });
            });
        }

        // 取消文件上传 - 修改：自动开始下一个文件
        function cancelFileUpload(fileName) {
            const fileData = selectedFiles.find(f => f.file.name === fileName);
            if (fileData && (fileData.status === 'uploading' || fileData.status === 'pending')) {
                // 如果是当前正在上传的文件，取消上传
                if (currentUploadController && fileData.status === 'uploading') {
                    currentUploadController.abort();
                    currentUploadController = null;
                }
                
                // 标记为已取消
                fileData.status = 'cancelled';
                fileData.error = '上传已取消';
                fileData.progress = 0;
                
                // 更新界面
                updateFileList();
                updateStats();
                
                // 如果正在上传过程中取消，自动开始下一个文件
                if (uploadInProgress) {
                    setTimeout(() => {
                        continueUpload();
                    }, 100);
                } else {
                    updateUploadButton();
                }
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // 更新上传按钮状态
        function updateUploadButton() {
            const visibleFiles = selectedFiles.filter(f => f.status !== 'cancelled');
            const hasFiles = visibleFiles.length > 0;
            const hasPendingFiles = visibleFiles.some(f => f.status === 'pending' || f.status === 'error');
            const shouldEnable = hasFiles && hasPendingFiles && !uploadInProgress;
            
            elements.startUpload.disabled = !shouldEnable;
            elements.startUpload.textContent = uploadInProgress ? '上传中...' : '开始上传';
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'pending': '等待',
                'uploading': '上传中',
                'completed': '完成',
                'error': '失败',
                'cancelled': '已取消'
            };
            return statusMap[status] || status;
        }

        // 开始上传
        async function startUpload() {
            if (uploadInProgress) return;
            
            const visibleFiles = selectedFiles.filter(f => f.status !== 'cancelled');
            const pendingFiles = visibleFiles.filter(f => f.status === 'pending' || f.status === 'error');
            if (pendingFiles.length === 0) return;
            
            uploadInProgress = true;
            currentUploadIndex = 0;
            updateUploadButton();
            
            await continueUpload();
        }

        // 继续上传下一个文件
        async function continueUpload() {
            const visibleFiles = selectedFiles.filter(f => f.status !== 'cancelled');
            const pendingFiles = visibleFiles.filter(f => f.status === 'pending' || f.status === 'error');
            
            if (pendingFiles.length === 0) {
                // 所有文件都处理完了
                uploadInProgress = false;
                currentUploadController = null;
                updateUploadButton();
                showResult(
                    visibleFiles.filter(f => f.status === 'completed').length,
                    visibleFiles.filter(f => f.status === 'error').length
                );
                return;
            }
            
            // 上传下一个文件
            const fileData = pendingFiles[0];
            currentUploadController = new AbortController();
            
            try {
                await uploadFile(fileData, currentUploadController.signal);
            } catch (error) {
                console.error(`文件 ${fileData.file.name} 上传失败:`, error);
            } finally {
                currentUploadController = null;
            }
            
            // 继续上传下一个文件
            setTimeout(() => {
                continueUpload();
            }, 100);
        }

        // 上传单个文件
        async function uploadFile(fileData, signal) {
            // 更新状态为上传中
            fileData.status = 'uploading';
            fileData.error = null;
            fileData.progress = 0;
            updateFileList();
            
            const fileSize = fileData.file.size;
            const totalChunks = Math.ceil(fileSize / CONFIG.CHUNK_SIZE);
            
            if (!fileData.fingerprint) {
                fileData.fingerprint = await generateFileFingerprint(fileData.file);
            }
            
            let retryCount = 0;
            
            while (retryCount <= CONFIG.MAX_RETRIES) {
                try {
                    // 上传所有分块
                    for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
                        if (signal.aborted) {
                            throw new DOMException('上传已取消', 'AbortError');
                        }
                        
                        const start = chunkIndex * CONFIG.CHUNK_SIZE;
                        const end = Math.min((chunkIndex + 1) * CONFIG.CHUNK_SIZE, fileSize);
                        const chunk = fileData.file.slice(start, end);
                        
                        const chunkBase64 = await readChunkAsBase64(chunk);
                        
                        // 上传分块数据
                        const uploadData = {
                            action: 'upload_chunk',
                            chunkIndex: chunkIndex,
                            totalChunks: totalChunks,
                            fileName: fileData.file.name,
                            fingerprint: fileData.fingerprint,
                            data: chunkBase64,
                            fileSize: fileSize,
                            gpsLatitude: fileData.fileInfo.latitude,
                            gpsLongitude: fileData.fileInfo.longitude
                        };
                        
                        if (fileData.fileInfo.earliestTime) {
                            uploadData.earliestTime = fileData.fileInfo.earliestTime;
                        }
                        
                        const result = await callCloudFunction(uploadData, signal);
                        
                        if (!result.success) {
                            throw new Error(`分块上传失败: ${result.message}`);
                        }
                        
                        fileData.progress = Math.round(((chunkIndex + 1) / totalChunks) * 100);
                        updateFileList();
                    }
                    
                    // 完成上传
                    const completeData = {
                        action: 'complete_upload',
                        fileName: fileData.file.name,
                        fingerprint: fileData.fingerprint,
                        totalChunks: totalChunks,
                        fileSize: fileSize,
                        gpsLatitude: fileData.fileInfo.latitude,
                        gpsLongitude: fileData.fileInfo.longitude
                    };
                    
                    if (fileData.fileInfo.earliestTime) {
                        completeData.earliestTime = fileData.fileInfo.earliestTime;
                    }
                    
                    const completeResult = await callCloudFunction(completeData, signal);
                    
                    if (!completeResult.success) {
                        throw new Error('文件合并失败: ' + completeResult.message);
                    }
                    
                    fileData.status = 'completed';
                    fileData.fileId = completeResult.fileID;
                    updateFileList();
                    
                    return completeResult;
                    
                } catch (error) {
                    if (error.name === 'AbortError') {
                        fileData.status = 'cancelled';
                        fileData.error = '上传已取消';
                        updateFileList();
                        throw error;
                    }
                    
                    retryCount++;
                    
                    if (retryCount > CONFIG.MAX_RETRIES) {
                        fileData.status = 'error';
                        fileData.error = `上传失败: ${error.message}`;
                        updateFileList();
                        throw error;
                    } else {
                        console.warn(`文件 ${fileData.file.name} 上传失败，第 ${retryCount} 次重试...`);
                        fileData.progress = 0;
                        updateFileList();
                        
                        // 等待一段时间后重试
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    }
                }
            }
        }

        // 生成文件指纹
        async function generateFileFingerprint(file) {
            return new Promise((resolve) => {
                const spark = new SparkMD5.ArrayBuffer();
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    spark.append(e.target.result);
                    const hash = spark.end();
                    resolve(hash);
                };
                
                reader.onerror = () => {
                    const backupHash = 'backup_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    resolve(backupHash);
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // 读取分块为Base64
        function readChunkAsBase64(chunk) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const dataURL = reader.result;
                    const base64Data = dataURL.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = reject;
                reader.readAsDataURL(chunk);
            });
        }

        // 调用云函数
        async function callCloudFunction(data, signal) {
            try {
                const response = await fetch(CONFIG.CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Referer': 'https://album-70p.pages.dev'
                    },
                    body: JSON.stringify(data),
                    signal: signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw error;
                }
                
                return {
                    success: false,
                    message: '网络请求失败: ' + error.message
                };
            }
        }

        // 检查服务状态
        async function checkServiceStatus() {
            try {
                const response = await fetch(CONFIG.CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Referer': 'https://album-70p.pages.dev'
                    },
                    body: JSON.stringify({
                        action: 'health_check'
                    })
                });
                
                if (response.ok) {
                    elements.serviceStatus.textContent = '✅ 服务正常';
                    elements.serviceStatus.style.background = '#e8f5e8';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                elements.serviceStatus.textContent = '❌ 服务连接失败';
                elements.serviceStatus.style.background = '#f8d7da';
            }
        }

        // 清空文件
        function clearFiles() {
            if (!uploadInProgress) {
                // 取消当前上传
                if (currentUploadController) {
                    currentUploadController.abort();
                    currentUploadController = null;
                }
                
                selectedFiles = [];
                updateFileList();
                updateUploadButton();
                updateStats();
                elements.resultInfo.style.display = 'none';
            } else {
                alert('上传进行中，请等待完成后清空');
            }
        }

        // 显示结果
        function showResult(success, error) {
            const visibleFiles = selectedFiles.filter(f => f.status !== 'cancelled');
            const withAddressCount = visibleFiles.filter(f => f.fileInfo.hasGPS).length;
            
            elements.resultContent.innerHTML = `
                <div>
                    <div>✅ 成功上传: ${success} 个文件</div>
                    <div>❌ 上传失败: ${error} 个文件</div>
                    <div>📍 含地址信息: ${withAddressCount} 个文件</div>
                    ${error > 0 ? '<div style="color: #dc3545; margin-top: 10px;">请检查网络连接后重试失败的文件</div>' : ''}
                </div>
            `;
            elements.resultInfo.style.display = 'block';
        }

        // 设置拖拽上传
        function setupDragAndDrop() {
            elements.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.add('active');
            });

            elements.uploadArea.addEventListener('dragleave', () => {
                elements.uploadArea.classList.remove('active');
            });

            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.classList.remove('active');
                if (e.dataTransfer.files.length) {
                    elements.fileInput.files = e.dataTransfer.files;
                    handleFileSelect({ target: elements.fileInput });
                }
            });
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
