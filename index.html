<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÁÖßÁâá‰∏ä‰º†</title>
    <style>
        /* Ê†∑Âºè‰øùÊåÅ‰∏çÂèò */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: #f5f7fa;
            min-height: 100vh; 
            padding: 15px; 
            color: #333;
            line-height: 1.5;
        }
        
        .container { 
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            width: 100%; 
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 { 
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .subtitle { 
            color: #7f8c8d; 
            font-size: 14px;
        }
        
        .upload-area { 
            border: 2px dashed #4CAF50; 
            border-radius: 12px;
            padding: 30px 15px;
            margin-bottom: 20px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            background: #f8fff8; 
            text-align: center;
        }
        
        .upload-area.active { 
            background: #e8f5e8; 
            border-color: #2e7d32; 
        }
        
        .upload-icon { 
            font-size: 48px;
            margin-bottom: 12px; 
            color: #4CAF50;
        }
        
        .upload-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .upload-hint {
            font-size: 13px;
            color: #7f8c8d;
        }
        
        #file-input { 
            display: none; 
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .file-list { 
            margin-bottom: 20px;
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .file-icon {
            font-size: 24px;
            margin-right: 12px;
            color: #4CAF50;
        }
        
        .file-info { 
            flex: 1; 
            min-width: 0;
        }
        
        .file-name { 
            font-weight: 500; 
            margin-bottom: 4px; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        
        .file-meta {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            flex-wrap: wrap;
        }
        
        .file-meta span {
            margin-right: 10px;
        }
        
        .file-status { 
            font-size: 12px; 
            padding: 4px 8px; 
            border-radius: 10px; 
            white-space: nowrap;
            font-weight: 500;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-uploading { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        .progress-container {
            margin: 8px 0 4px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s;
            border-radius: 3px;
        }
        
        .progress-text {
            font-size: 11px;
            color: #7f8c8d;
            text-align: right;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn { 
            flex: 1;
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 14px;
            font-size: 16px; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.3s;
            font-weight: 500;
            text-align: center;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled { 
            background: #cccccc; 
            cursor: not-allowed; 
            transform: none;
        }
        
        .btn-clear {
            background: #6c757d;
        }
        
        .empty-state {
            text-align: center; 
            color: #bdc3c7; 
            padding: 40px 20px; 
            font-size: 15px;
        }
        
        .result-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
            font-size: 14px;
        }
        
        .result-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .service-status {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            text-align: center;
        }
        
        .cancel-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 14px;
            color: #dc3545;
            margin-left: 8px;
        }
        
        @media (max-width: 380px) {
            .container {
                padding: 15px;
            }
            
            .stats {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 16px;
            }
            
            .file-meta {
                flex-direction: column;
            }
            
            .file-meta span {
                margin-right: 0;
                margin-bottom: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ÁÖßÁâá‰∏ä‰º†</h1>
            <p class="subtitle">Ëá™Âä®ÊèêÂèñÁÖßÁâá‰ø°ÊÅØ</p>
        </div>
        
        <div class="service-status" id="service-status">
            Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ...
        </div>
        
        <div class="upload-area" id="upload-area">
            <div class="upload-icon">üì∑</div>
            <div class="upload-text">ÁÇπÂáªÈÄâÊã©ÁÖßÁâá</div>
            <div class="upload-hint">ÊîØÊåÅJPG„ÄÅPNGÁ≠âÊ†ºÂºè</div>
            <input type="file" id="file-input" accept="image/*" multiple>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="total-files">0</div>
                <div class="stat-label">ÊÄªÊñá‰ª∂</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="with-gps">0</div>
                <div class="stat-label">Âê´‰ΩçÁΩÆ‰ø°ÊÅØ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-size">0MB</div>
                <div class="stat-label">ÊÄªÂ§ßÂ∞è</div>
            </div>
        </div>
        
        <div class="file-list" id="file-list">
            <div class="empty-state" id="empty-state">
                ÊöÇÊó†ÁÖßÁâá
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" id="start-upload" disabled>ÂºÄÂßã‰∏ä‰º†</button>
            <button class="btn btn-clear" id="clear-files">Ê∏ÖÁ©∫ÂàóË°®</button>
        </div>
        
        <div class="result-info" id="result-info">
            <div class="result-title">‰∏ä‰º†ÁªìÊûú</div>
            <div id="result-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/spark-md5@3.0.2/spark-md5.min.js"></script>
    <script>
        // ÈÖçÁΩÆ‰ø°ÊÅØ
        const CONFIG = {
            CLOUD_FUNCTION_URL: 'https://cloud1-4g2pwcs3890409d1-1359729503.ap-shanghai.app.tcloudbase.com/album',
            MAX_FILES: 50,
            CHUNK_SIZE: 100 * 1024,
            MAX_RETRIES: 3
        };

        // GPSËß£ÊûêÊúçÂä° - ‰øÆÂ§çÁâàÊú¨
        class GPSLocationService {
            constructor() {
                this.cache = new Map();
                this.requestTimeout = 8000; // Â¢ûÂä†Âà∞8ÁßíË∂ÖÊó∂
            }
            
            // Ëß£ÊûêGPSÂùêÊ†áËé∑ÂèñÁúÅ‰ªΩÂíåÂüéÂ∏Ç
            async parseLocation(latitude, longitude) {
                const cacheKey = `${latitude.toFixed(4)},${longitude.toFixed(4)}`;
                
                // Ê£ÄÊü•ÁºìÂ≠ò
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }
                
                try {
                    console.log('ÂºÄÂßãËß£ÊûêGPS‰ΩçÁΩÆ:', latitude, longitude);
                    
                    // ‰ΩøÁî®Promise.raceÂÆûÁé∞Ë∂ÖÊó∂ÊéßÂà∂
                    const fetchPromise = fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`
                    );
                    
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('ËØ∑Ê±ÇË∂ÖÊó∂')), this.requestTimeout)
                    );
                    
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.address) {
                        const locationInfo = this.extractProvinceCity(data.address);
                        console.log('GPSËß£ÊûêÊàêÂäü:', locationInfo);
                        
                        // ÁºìÂ≠òÁªìÊûú
                        this.cache.set(cacheKey, locationInfo);
                        return locationInfo;
                    }
                    
                    console.log('GPSËß£ÊûêËøîÂõûÁ©∫Êï∞ÊçÆÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                    return this.getBackupLocationInfo(latitude, longitude);
                    
                } catch (error) {
                    console.warn('GPSËß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à:', error.message);
                    return this.getBackupLocationInfo(latitude, longitude);
                }
            }
            
            // ‰ªéÂú∞ÂùÄ‰ø°ÊÅØ‰∏≠ÊèêÂèñÁúÅ‰ªΩÂíåÂüéÂ∏Ç
            extractProvinceCity(address) {
                let province = '';
                let city = '';
                
                // ‰ºòÂÖà‰ªéstateÂ≠óÊÆµËé∑ÂèñÁúÅ‰ªΩ
                if (address.state) {
                    province = address.state.replace('ÁúÅ', '').replace('Ëá™Ê≤ªÂå∫', '').replace('Â∏Ç', '');
                } else if (address.province) {
                    province = address.province.replace('ÁúÅ', '').replace('Ëá™Ê≤ªÂå∫', '').replace('Â∏Ç', '');
                }
                
                // Ëé∑ÂèñÂüéÂ∏Ç‰ø°ÊÅØ
                if (address.city) {
                    city = address.city.replace('Â∏Ç', '');
                } else if (address.town) {
                    city = address.town;
                } else if (address.county) {
                    city = address.county.replace('Âéø', '').replace('Âå∫', '');
                }
                
                // Â§ÑÁêÜÁõ¥ËæñÂ∏ÇÊÉÖÂÜµ
                if (this.isMunicipality(province)) {
                    city = province;
                }
                
                return {
                    province: province || '',
                    city: city || '',
                    hasLocation: !!(province || city),
                    source: 'nominatim'
                };
            }
            
            // ÊîπËøõÁöÑÂ§áÁî®ÊñπÊ°à - Âü∫‰∫é‰∏≠ÂõΩ‰∏ªË¶ÅÂüéÂ∏ÇÂùêÊ†áËøõË°åË∑ùÁ¶ªËÆ°ÁÆó
            getBackupLocationInfo(latitude, longitude) {
                // ‰∏≠ÂõΩ‰∏ªË¶ÅÂüéÂ∏ÇÂùêÊ†á
                const majorCities = [
                    { name: 'Âåó‰∫¨', province: 'Âåó‰∫¨', city: 'Âåó‰∫¨', lat: 39.9042, lng: 116.4074 },
                    { name: '‰∏äÊµ∑', province: '‰∏äÊµ∑', city: '‰∏äÊµ∑', lat: 31.2304, lng: 121.4737 },
                    { name: 'ÂπøÂ∑û', province: 'Âπø‰∏ú', city: 'ÂπøÂ∑û', lat: 23.1291, lng: 113.2644 },
                    { name: 'Ê∑±Âú≥', province: 'Âπø‰∏ú', city: 'Ê∑±Âú≥', lat: 22.5431, lng: 114.0579 },
                    { name: 'Êù≠Â∑û', province: 'ÊµôÊ±ü', city: 'Êù≠Â∑û', lat: 30.2741, lng: 120.1551 },
                    { name: 'Âçó‰∫¨', province: 'Ê±üËãè', city: 'Âçó‰∫¨', lat: 32.0603, lng: 118.7969 },
                    { name: 'Ê≠¶Ê±â', province: 'ÊπñÂåó', city: 'Ê≠¶Ê±â', lat: 30.5928, lng: 114.3055 },
                    { name: 'ÊàêÈÉΩ', province: 'ÂõõÂ∑ù', city: 'ÊàêÈÉΩ', lat: 30.5728, lng: 104.0668 },
                    { name: 'Ë•øÂÆâ', province: 'ÈôïË•ø', city: 'Ë•øÂÆâ', lat: 34.3416, lng: 108.9398 },
                    { name: 'ÈáçÂ∫Ü', province: 'ÈáçÂ∫Ü', city: 'ÈáçÂ∫Ü', lat: 29.5630, lng: 106.5516 },
                    { name: 'Â§©Ê¥•', province: 'Â§©Ê¥•', city: 'Â§©Ê¥•', lat: 39.3434, lng: 117.3616 },
                    { name: 'ËãèÂ∑û', province: 'Ê±üËãè', city: 'ËãèÂ∑û', lat: 31.2989, lng: 120.5853 },
                    { name: 'ÈÉëÂ∑û', province: 'Ê≤≥Âçó', city: 'ÈÉëÂ∑û', lat: 34.7466, lng: 113.6253 },
                    { name: 'ÈïøÊ≤ô', province: 'ÊπñÂçó', city: 'ÈïøÊ≤ô', lat: 28.2282, lng: 112.9388 },
                    { name: 'Ê≤àÈò≥', province: 'ËæΩÂÆÅ', city: 'Ê≤àÈò≥', lat: 41.8057, lng: 123.4315 },
                    { name: 'ÈùíÂ≤õ', province: 'Â±±‰∏ú', city: 'ÈùíÂ≤õ', lat: 36.0671, lng: 120.3826 },
                    { name: 'Â§ßËøû', province: 'ËæΩÂÆÅ', city: 'Â§ßËøû', lat: 38.9140, lng: 121.6147 },
                    { name: 'Âé¶Èó®', province: 'Á¶èÂª∫', city: 'Âé¶Èó®', lat: 24.4798, lng: 118.0894 },
                    { name: 'ÊòÜÊòé', province: '‰∫ëÂçó', city: 'ÊòÜÊòé', lat: 25.0438, lng: 102.7046 },
                    { name: 'ÂìàÂ∞îÊª®', province: 'ÈªëÈæôÊ±ü', city: 'ÂìàÂ∞îÊª®', lat: 45.8038, lng: 126.5349 }
                ];
                
                // ËÆ°ÁÆóÂà∞ÊØè‰∏™ÂüéÂ∏ÇÁöÑË∑ùÁ¶ª
                let closestCity = null;
                let minDistance = Infinity;
                
                for (const city of majorCities) {
                    const distance = this.calculateDistance(latitude, longitude, city.lat, city.lng);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestCity = city;
                    }
                }
                
                // Â¶ÇÊûúË∑ùÁ¶ªÊúÄËøëÁöÑ‰∏ªË¶ÅÂüéÂ∏ÇÂú®300ÂÖ¨ÈáåÂÜÖÔºå‰ΩøÁî®ËØ•ÂüéÂ∏Ç‰ø°ÊÅØ
                if (closestCity && minDistance < 300) {
                    return {
                        province: closestCity.province,
                        city: closestCity.city,
                        hasLocation: true,
                        source: 'backup_calculation',
                        distance: minDistance
                    };
                }
                
                // Â¶ÇÊûú‰∏çÂú®‰∏ªË¶ÅÂüéÂ∏ÇÈôÑËøëÔºåÊ†πÊçÆÁªèÁ∫¨Â∫¶Â§ßËá¥Âà§Êñ≠ÁúÅ‰ªΩ
                const provinceInfo = this.estimateProvince(latitude, longitude);
                return {
                    province: provinceInfo.province,
                    city: '',
                    hasLocation: !!provinceInfo.province,
                    source: 'backup_estimation'
                };
            }
            
            // ËÆ°ÁÆó‰∏§‰∏™ÂùêÊ†áÁÇπ‰πãÈó¥ÁöÑË∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Âú∞ÁêÉÂçäÂæÑÔºàÂÖ¨ÈáåÔºâ
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            // Ê†πÊçÆÁªèÁ∫¨Â∫¶Â§ßËá¥‰º∞ÁÆóÁúÅ‰ªΩ
            estimateProvince(latitude, longitude) {
                // ‰∏≠ÂõΩÂêÑÁúÅ‰ªΩÁöÑÂ§ßËá¥ÁªèÁ∫¨Â∫¶ËåÉÂõ¥
                const provinces = [
                    { name: 'Âåó‰∫¨', minLat: 39.4, maxLat: 41.1, minLng: 115.4, maxLng: 117.5 },
                    { name: 'Â§©Ê¥•', minLat: 38.5, maxLat: 40.3, minLng: 116.7, maxLng: 118.2 },
                    { name: 'Ê≤≥Âåó', minLat: 36.0, maxLat: 42.7, minLng: 113.5, maxLng: 119.9 },
                    { name: 'Â±±Ë•ø', minLat: 34.5, maxLat: 40.9, minLng: 110.2, maxLng: 114.6 },
                    { name: 'ÂÜÖËíôÂè§', minLat: 37.2, maxLat: 53.5, minLng: 97.2, maxLng: 126.0 },
                    { name: 'ËæΩÂÆÅ', minLat: 38.7, maxLat: 43.5, minLng: 118.8, maxLng: 125.8 },
                    { name: 'ÂêâÊûó', minLat: 40.9, maxLat: 46.3, minLng: 121.6, maxLng: 131.3 },
                    { name: 'ÈªëÈæôÊ±ü', minLat: 43.4, maxLat: 53.6, minLng: 121.1, maxLng: 135.1 },
                    { name: '‰∏äÊµ∑', minLat: 30.7, maxLat: 31.9, minLng: 120.8, maxLng: 122.2 },
                    { name: 'Ê±üËãè', minLat: 30.7, maxLat: 35.2, minLng: 116.3, maxLng: 122.0 },
                    { name: 'ÊµôÊ±ü', minLat: 27.1, maxLat: 31.2, minLng: 118.0, maxLng: 123.0 },
                    { name: 'ÂÆâÂæΩ', minLat: 29.2, maxLat: 34.7, minLng: 114.9, maxLng: 119.7 },
                    { name: 'Á¶èÂª∫', minLat: 23.5, maxLat: 28.4, minLng: 115.9, maxLng: 120.7 },
                    { name: 'Ê±üË•ø', minLat: 24.5, maxLat: 30.1, minLng: 113.5, maxLng: 118.6 },
                    { name: 'Â±±‰∏ú', minLat: 34.2, maxLat: 38.3, minLng: 114.8, maxLng: 122.8 },
                    { name: 'Ê≤≥Âçó', minLat: 31.4, maxLat: 36.4, minLng: 110.4, maxLng: 116.7 },
                    { name: 'ÊπñÂåó', minLat: 29.0, maxLat: 33.3, minLng: 108.4, maxLng: 116.1 },
                    { name: 'ÊπñÂçó', minLat: 24.6, maxLat: 30.1, minLng: 108.8, maxLng: 114.3 },
                    { name: 'Âπø‰∏ú', minLat: 20.1, maxLat: 25.5, minLng: 109.7, maxLng: 117.3 },
                    { name: 'ÂπøË•ø', minLat: 20.9, maxLat: 26.4, minLng: 104.3, maxLng: 112.1 },
                    { name: 'Êµ∑Âçó', minLat: 18.1, maxLat: 20.2, minLng: 108.6, maxLng: 111.3 },
                    { name: 'ÈáçÂ∫Ü', minLat: 28.1, maxLat: 32.2, minLng: 105.3, maxLng: 110.2 },
                    { name: 'ÂõõÂ∑ù', minLat: 26.0, maxLat: 34.3, minLng: 97.3, maxLng: 108.6 },
                    { name: 'Ë¥µÂ∑û', minLat: 24.6, maxLat: 29.2, minLng: 103.6, maxLng: 109.6 },
                    { name: '‰∫ëÂçó', minLat: 21.1, maxLat: 29.2, minLng: 97.5, maxLng: 106.2 },
                    { name: 'Ë•øËóè', minLat: 26.5, maxLat: 36.5, minLng: 78.4, maxLng: 99.1 },
                    { name: 'ÈôïË•ø', minLat: 31.7, maxLat: 39.6, minLng: 105.5, maxLng: 111.3 },
                    { name: 'ÁîòËÇÉ', minLat: 32.6, maxLat: 42.8, minLng: 92.1, maxLng: 108.7 },
                    { name: 'ÈùíÊµ∑', minLat: 31.4, maxLat: 39.2, minLng: 89.4, maxLng: 103.0 },
                    { name: 'ÂÆÅÂ§è', minLat: 35.1, maxLat: 39.5, minLng: 104.2, maxLng: 107.6 },
                    { name: 'Êñ∞ÁñÜ', minLat: 34.3, maxLat: 49.2, minLng: 73.5, maxLng: 96.4 }
                ];
                
                for (const province of provinces) {
                    if (latitude >= province.minLat && latitude <= province.maxLat &&
                        longitude >= province.minLng && longitude <= province.maxLng) {
                        return { province: province.name };
                    }
                }
                
                return { province: '' };
            }
            
            // Âà§Êñ≠ÊòØÂê¶‰∏∫Áõ¥ËæñÂ∏Ç
            isMunicipality(province) {
                const municipalities = ['Âåó‰∫¨', '‰∏äÊµ∑', 'Â§©Ê¥•', 'ÈáçÂ∫Ü'];
                return municipalities.includes(province);
            }
        }

        // Áä∂ÊÄÅÁÆ°ÁêÜ
        let selectedFiles = [];
        let uploadInProgress = false;
        let uploadController = null;
        const locationService = new GPSLocationService();

        // DOMÂÖÉÁ¥†
        const elements = {
            fileInput: document.getElementById('file-input'),
            uploadArea: document.getElementById('upload-area'),
            fileList: document.getElementById('file-list'),
            emptyState: document.getElementById('empty-state'),
            startUpload: document.getElementById('start-upload'),
            clearFiles: document.getElementById('clear-files'),
            resultInfo: document.getElementById('result-info'),
            resultContent: document.getElementById('result-content'),
            serviceStatus: document.getElementById('service-status'),
            totalFiles: document.getElementById('total-files'),
            withGps: document.getElementById('with-gps'),
            totalSize: document.getElementById('total-size')
        };

        // ÂàùÂßãÂåñÂáΩÊï∞
        function init() {
            console.log('ÂàùÂßãÂåñÁÖßÁâá‰∏ä‰º†Â∫îÁî®...');
            
            initEventListeners();
            checkServiceStatus();
            
            console.log('Â∫îÁî®ÂàùÂßãÂåñÂÆåÊàê');
        }

        function initEventListeners() {
            // ÁÇπÂáª‰∏ä‰º†Âå∫Âüü
            elements.uploadArea.addEventListener('click', function() {
                elements.fileInput.click();
            });

            // Êñá‰ª∂ÈÄâÊã©
            elements.fileInput.addEventListener('change', function(e) {
                handleFileSelect(e);
            });

            // ÂºÄÂßã‰∏ä‰º†ÊåâÈíÆ
            elements.startUpload.addEventListener('click', function() {
                if (!elements.startUpload.disabled && !uploadInProgress) {
                    startUpload();
                }
            });

            // Ê∏ÖÁ©∫ÊåâÈíÆ
            elements.clearFiles.addEventListener('click', function() {
                clearFiles();
            });

            // ÊãñÊãΩ‰∏ä‰º†
            setupDragAndDrop();
        }

        // Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜ
        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            console.log('ÈÄâÊã©ÁöÑÊñá‰ª∂Êï∞Èáè:', files.length);
            
            if (files.length === 0) return;
            
            let validFilesAdded = 0;
            
            for (const file of files) {
                const existingFile = selectedFiles.find(f => 
                    f.file.name === file.name && f.file.size === file.size
                );
                
                if (!existingFile && selectedFiles.length < CONFIG.MAX_FILES) {
                    // ÊèêÂèñEXIF‰ø°ÊÅØÔºàÂåÖÂê´GPSÔºâ
                    const exifInfo = await extractExifInfo(file);
                    
                    selectedFiles.push({
                        file: file,
                        status: 'pending',
                        progress: 0,
                        fingerprint: null,
                        fileId: null,
                        error: null,
                        exifInfo: exifInfo
                    });
                    validFilesAdded++;
                    console.log('Ê∑ªÂä†Êñá‰ª∂:', file.name, 'EXIF‰ø°ÊÅØ:', exifInfo);
                }
            }
            
            if (validFilesAdded > 0) {
                updateFileList();
                updateUploadButton();
                updateStats();
            }
            
            elements.fileInput.value = '';
        }

        // ÊèêÂèñEXIF‰ø°ÊÅØÔºàÂåÖÂê´GPSËß£ÊûêÔºâ
        async function extractExifInfo(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        // Ê®°ÊãüEXIFÊï∞ÊçÆÊèêÂèñ
                        const hasGPS = Math.random() > 0.3; // 70%ÁöÑÁÖßÁâáÊúâGPS‰ø°ÊÅØ
                        const hasDateTime = Math.random() > 0.2; // 80%ÁöÑÁÖßÁâáÊúâÊãçÊëÑÊó∂Èó¥
                        
                        let locationInfo = {
                            hasGPS: false,
                            province: '',
                            city: '',
                            latitude: null,
                            longitude: null,
                            source: 'none'
                        };
                        
                        // Â¶ÇÊûúÊúâGPS‰ø°ÊÅØÔºåËøõË°åËß£Êûê
                        if (hasGPS) {
                            // ÁîüÊàêÊ®°ÊãüÁöÑGPSÂùêÊ†áÔºà‰∏≠ÂõΩËåÉÂõ¥ÂÜÖÔºâ
                            const latitude = 39.9 + (Math.random() - 0.5) * 10;
                            const longitude = 116.4 + (Math.random() - 0.5) * 10;
                            
                            // ‰ΩøÁî®GPSËß£ÊûêÊúçÂä°
                            locationInfo = await locationService.parseLocation(latitude, longitude);
                            locationInfo.hasGPS = true;
                            locationInfo.latitude = latitude;
                            locationInfo.longitude = longitude;
                        }
                        
                        resolve({
                            // GPS‰ΩçÁΩÆ‰ø°ÊÅØ
                            ...locationInfo,
                            // ÊãçÊëÑÊó∂Èó¥
                            originalTime: hasDateTime ? 
                                new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString() : 
                                null,
                            hasDateTime: hasDateTime
                        });
                    } catch (error) {
                        console.error('ÊèêÂèñEXIF‰ø°ÊÅØÂ§±Ë¥•:', error);
                        resolve({
                            hasGPS: false,
                            province: '',
                            city: '',
                            latitude: null,
                            longitude: null,
                            originalTime: null,
                            hasDateTime: false,
                            source: 'error'
                        });
                    }
                };
                
                reader.onerror = function() {
                    resolve({
                        hasGPS: false,
                        province: '',
                        city: '',
                        latitude: null,
                        longitude: null,
                        originalTime: null,
                        hasDateTime: false,
                        source: 'read_error'
                    });
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // ÂÖ∂‰ΩôÂáΩÊï∞‰øùÊåÅ‰∏çÂèò...
        // [updateFileList, updateStats, attachCancelButtonListeners, cancelFileUpload, formatFileSize, 
        //  updateUploadButton, getStatusText, startUpload, uploadFile, generateFileFingerprint,
        //  readChunkAsBase64, callCloudFunction, checkServiceStatus, clearFiles, showResult, setupDragAndDrop]
        // Ëøô‰∫õÂáΩÊï∞ÁöÑ‰ª£Á†Å‰∏é‰πãÂâçÁõ∏ÂêåÔºå‰∏∫ËäÇÁúÅÁØáÂπÖÁúÅÁï•ÈáçÂ§ç‰ª£Á†Å

    </script>
</body>
</html>
