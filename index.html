<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>照片上传</title>
    <style>
        /* 样式保持不变 */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML结构保持不变 -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/spark-md5@3.0.2/spark-md5.min.js"></script>
    <!-- 添加 EXIF.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script>
        // 配置信息 - 串行上传
        const CONFIG = {
            CLOUD_FUNCTION_URL: 'https://cloud1-4g2pwcs3890409d1-1359729503.ap-shanghai.app.tcloudbase.com/album',
            MAX_FILES: 50,
            CHUNK_SIZE: 50 * 1024,
            MAX_RETRIES: 3
        };

        // 状态管理
        let selectedFiles = [];
        let uploadInProgress = false;
        let currentUploadController = null;
        let currentUploadIndex = 0;

        // DOM元素
        const elements = {
            fileInput: document.getElementById('file-input'),
            uploadArea: document.getElementById('upload-area'),
            fileList: document.getElementById('file-list'),
            emptyState: document.getElementById('empty-state'),
            startUpload: document.getElementById('start-upload'),
            clearFiles: document.getElementById('clear-files'),
            resultInfo: document.getElementById('result-info'),
            resultContent: document.getElementById('result-content'),
            serviceStatus: document.getElementById('service-status'),
            totalFiles: document.getElementById('total-files'),
            withAddress: document.getElementById('with-address'),
            totalSize: document.getElementById('total-size')
        };

        // 初始化函数
        function init() {
            initEventListeners();
            checkServiceStatus();
        }

        function initEventListeners() {
            elements.uploadArea.addEventListener('click', function() {
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', function(e) {
                handleFileSelect(e);
            });

            elements.startUpload.addEventListener('click', function() {
                if (!elements.startUpload.disabled && !uploadInProgress) {
                    startUpload();
                }
            });

            elements.clearFiles.addEventListener('click', function() {
                clearFiles();
            });

            setupDragAndDrop();
        }

        // 文件选择处理
        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            let validFilesAdded = 0;
            
            for (const file of files) {
                const existingFile = selectedFiles.find(f => 
                    f.file.name === file.name && f.file.size === file.size
                );
                
                if (!existingFile && selectedFiles.length < CONFIG.MAX_FILES) {
                    // 提取照片信息
                    const fileInfo = await extractFileInfo(file);
                    
                    selectedFiles.push({
                        file: file,
                        status: 'pending',
                        progress: 0,
                        fingerprint: null,
                        fileId: null,
                        error: null,
                        fileInfo: fileInfo
                    });
                    validFilesAdded++;
                }
            }
            
            if (validFilesAdded > 0) {
                updateFileList();
                updateUploadButton();
                updateStats();
            }
            
            elements.fileInput.value = '';
        }

        // 提取照片信息 - 修复GPS提取问题
        async function extractFileInfo(file) {
            return new Promise((resolve) => {
                // 方法1: 使用EXIF.js
                EXIF.getData(file, function() {
                    try {
                        console.log('开始提取文件信息:', file.name);
                        
                        // 获取所有EXIF数据
                        const allExifData = EXIF.getAllTags(this);
                        console.log('完整EXIF数据:', allExifData);
                        
                        // 特别检查GPS相关标签
                        const gpsTags = {};
                        Object.keys(allExifData).forEach(key => {
                            if (key.includes('GPS') || key.includes('gps')) {
                                gpsTags[key] = allExifData[key];
                            }
                        });
                        console.log('GPS相关标签:', gpsTags);
                        
                        // 提取GPS信息 - 使用多种方法
                        const gpsInfo = extractGPSInfo(allExifData);
                        
                        // 提取时间信息
                        const timeInfo = extractTimeInfo(allExifData, file);
                        
                        // 如果EXIF.js没有提取到GPS，尝试其他方法
                        if (!gpsInfo.hasGPS) {
                            console.log('EXIF.js未提取到GPS，尝试其他方法...');
                            const alternativeGPS = await tryAlternativeGPSMethods(file);
                            if (alternativeGPS.hasGPS) {
                                Object.assign(gpsInfo, alternativeGPS);
                            }
                        }
                        
                        console.log('最终GPS信息:', gpsInfo);
                        
                        resolve({
                            ...gpsInfo,
                            ...timeInfo,
                            rawExif: allExifData
                        });
                    } catch (error) {
                        console.error('提取EXIF信息失败:', error);
                        // 如果EXIF提取失败，尝试其他方法
                        tryAlternativeGPSMethods(file).then(alternativeResult => {
                            resolve({
                                ...alternativeResult,
                                earliestTime: null,
                                hasTime: false
                            });
                        }).catch(() => {
                            resolve({
                                hasGPS: false,
                                latitude: null,
                                longitude: null,
                                earliestTime: null,
                                hasTime: false
                            });
                        });
                    }
                });
            });
        }

        // 尝试其他GPS提取方法
        async function tryAlternativeGPSMethods(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        // 方法2: 尝试从二进制数据中查找GPS信息
                        const arrayBuffer = e.target.result;
                        const gpsInfo = findGPSInBinary(arrayBuffer);
                        
                        if (gpsInfo.hasGPS) {
                            console.log('从二进制数据中找到GPS信息');
                            resolve(gpsInfo);
                        } else {
                            // 方法3: 尝试使用DataView读取
                            const dataViewGPS = parseGPSWithDataView(arrayBuffer);
                            if (dataViewGPS.hasGPS) {
                                console.log('使用DataView找到GPS信息');
                                resolve(dataViewGPS);
                            } else {
                                resolve({
                                    hasGPS: false,
                                    latitude: null,
                                    longitude: null
                                });
                            }
                        }
                    } catch (error) {
                        console.error('其他GPS提取方法失败:', error);
                        resolve({
                            hasGPS: false,
                            latitude: null,
                            longitude: null
                        });
                    }
                };
                
                reader.onerror = function() {
                    resolve({
                        hasGPS: false,
                        latitude: null,
                        longitude: null
                    });
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // 从二进制数据中查找GPS信息
        function findGPSInBinary(arrayBuffer) {
            try {
                const uint8Array = new Uint8Array(arrayBuffer);
                const decoder = new TextDecoder('utf-8');
                const text = decoder.decode(uint8Array);
                
                // 查找常见的GPS标记
                if (text.includes('GPS') || text.includes('gps')) {
                    console.log('在二进制数据中找到GPS标记');
                    // 这里可以添加更复杂的GPS数据解析逻辑
                }
                
                return {
                    hasGPS: false,
                    latitude: null,
                    longitude: null
                };
            } catch (error) {
                return {
                    hasGPS: false,
                    latitude: null,
                    longitude: null
                };
            }
        }

        // 使用DataView解析GPS
        function parseGPSWithDataView(arrayBuffer) {
            try {
                const dataView = new DataView(arrayBuffer);
                
                // 查找EXIF头 (0xFF 0xE1)
                for (let i = 0; i < arrayBuffer.byteLength - 4; i++) {
                    if (dataView.getUint16(i) === 0xFFE1) {
                        console.log('找到EXIF段');
                        // 这里可以添加EXIF段解析逻辑
                    }
                }
                
                return {
                    hasGPS: false,
                    latitude: null,
                    longitude: null
                };
            } catch (error) {
                return {
                    hasGPS: false,
                    latitude: null,
                    longitude: null
                };
            }
        }

        // 提取GPS信息 - 增强版本
        function extractGPSInfo(exifData) {
            const gpsInfo = {
                hasGPS: false,
                latitude: null,
                longitude: null,
                rawGPS: null,
                debug: {}
            };
            
            // 记录所有GPS相关标签用于调试
            Object.keys(exifData).forEach(key => {
                if (key.toUpperCase().includes('GPS')) {
                    gpsInfo.debug[key] = exifData[key];
                }
            });
            
            console.log('GPS调试信息:', gpsInfo.debug);
            
            // 检查是否存在GPS数据 - 多种可能的标签名称
            const gpsLatitude = exifData.GPSLatitude || exifData.gpsLatitude;
            const gpsLongitude = exifData.GPSLongitude || exifData.gpsLongitude;
            const gpsLatitudeRef = exifData.GPSLatitudeRef || exifData.gpsLatitudeRef;
            const gpsLongitudeRef = exifData.GPSLongitudeRef || exifData.gpsLongitudeRef;
            
            if (gpsLatitude && gpsLongitude) {
                console.log('找到GPS坐标:', {
                    latitude: gpsLatitude,
                    longitude: gpsLongitude,
                    latRef: gpsLatitudeRef,
                    longRef: gpsLongitudeRef
                });
                
                gpsInfo.hasGPS = true;
                gpsInfo.rawGPS = {
                    latitude: gpsLatitude,
                    longitude: gpsLongitude,
                    latitudeRef: gpsLatitudeRef,
                    longitudeRef: gpsLongitudeRef
                };
                
                // 转换GPS坐标为十进制
                gpsInfo.latitude = convertGPSCoordinate(gpsLatitude, gpsLatitudeRef);
                gpsInfo.longitude = convertGPSCoordinate(gpsLongitude, gpsLongitudeRef);
                
                console.log('转换后的GPS坐标:', {
                    latitude: gpsInfo.latitude,
                    longitude: gpsInfo.longitude
                });
            } else {
                console.log('未找到GPS坐标数据');
                // 检查是否有其他格式的GPS数据
                if (exifData.GPSInfo) {
                    console.log('找到GPSInfo:', exifData.GPSInfo);
                }
                if (exifData.gps) {
                    console.log('找到gps:', exifData.gps);
                }
            }
            
            return gpsInfo;
        }

        // 转换GPS坐标为十进制 - 增强版本
        function convertGPSCoordinate(coord, ref) {
            if (!coord) {
                console.log('坐标数据为空');
                return null;
            }
            
            try {
                console.log('转换坐标:', coord, '参考:', ref);
                
                // 处理不同的坐标格式
                let degrees, minutes, seconds;
                
                if (Array.isArray(coord)) {
                    // 格式: [度, 分, 秒]
                    if (coord.length >= 3) {
                        degrees = coord[0];
                        minutes = coord[1];
                        seconds = coord[2];
                    } else {
                        console.log('坐标数组长度不足:', coord.length);
                        return null;
                    }
                } else if (typeof coord === 'string') {
                    // 格式: "36;48;28.98"
                    const parts = coord.split(';');
                    if (parts.length >= 3) {
                        degrees = parseFloat(parts[0]);
                        minutes = parseFloat(parts[1]);
                        seconds = parseFloat(parts[2]);
                    } else {
                        console.log('坐标字符串格式错误:', coord);
                        return null;
                    }
                } else if (typeof coord === 'number') {
                    // 直接是十进制数字
                    let decimal = coord;
                    if (ref === 'S' || ref === 'W') {
                        decimal = -decimal;
                    }
                    return decimal;
                } else {
                    console.log('未知坐标格式:', typeof coord, coord);
                    return null;
                }
                
                // 确保值是数字
                degrees = typeof degrees === 'number' ? degrees : parseFloat(degrees);
                minutes = typeof minutes === 'number' ? minutes : parseFloat(minutes);
                seconds = typeof seconds === 'number' ? seconds : parseFloat(seconds);
                
                if (isNaN(degrees) || isNaN(minutes) || isNaN(seconds)) {
                    console.log('坐标值包含非数字:', degrees, minutes, seconds);
                    return null;
                }
                
                // 转换为十进制
                let decimal = degrees + minutes / 60 + seconds / 3600;
                
                // 根据参考方向调整正负
                if (ref === 'S' || ref === 'W') {
                    decimal = -decimal;
                }
                
                console.log('坐标转换结果:', decimal);
                return decimal;
                
            } catch (error) {
                console.error('GPS坐标转换失败:', error, '坐标:', coord, '参考:', ref);
                return null;
            }
        }

        // 提取时间信息
        function extractTimeInfo(exifData, file) {
            const times = {};
            
            // EXIF拍摄时间（最准确）
            if (exifData.DateTimeOriginal) {
                times.exifTime = parseEXIFDate(exifData.DateTimeOriginal);
            }
            
            // EXIF创建时间
            if (exifData.DateTime) {
                times.exifCreateTime = parseEXIFDate(exifData.DateTime);
            }
            
            // 文件修改时间
            if (file.lastModified) {
                times.lastModified = new Date(file.lastModified).toISOString();
            }
            
            // 选择最早的时间
            const earliestTime = getEarliestTime(times);
            
            return {
                earliestTime: earliestTime,
                hasTime: !!earliestTime,
                rawTimes: times
            };
        }

        // 解析EXIF日期格式
        function parseEXIFDate(dateString) {
            try {
                // EXIF日期格式: "YYYY:MM:DD HH:MM:SS"
                const parts = dateString.split(' ');
                const datePart = parts[0].replace(/:/g, '-');
                const timePart = parts[1];
                const result = new Date(datePart + 'T' + timePart).toISOString();
                console.log('解析EXIF日期:', dateString, '->', result);
                return result;
            } catch (error) {
                console.error('解析EXIF日期失败:', error, '日期字符串:', dateString);
                return null;
            }
        }

        // 从多个时间中选择最早的一个
        function getEarliestTime(timeObj) {
            const validTimes = Object.values(timeObj).filter(time => time && time !== 'Invalid Date');
            
            if (validTimes.length === 0) {
                return null;
            }
            
            // 将时间字符串转换为Date对象进行比较
            const timeDates = validTimes.map(time => new Date(time));
            
            // 找到最早的时间
            const earliestDate = timeDates.reduce((earliest, current) => {
                return current < earliest ? current : earliest;
            });
            
            return earliestDate.toISOString();
        }

        // 更新文件列表 - 显示详细的GPS信息
        function updateFileList() {
            // 只显示未取消的文件
            const visibleFiles = selectedFiles.filter(f => f.status !== 'cancelled');
            
            if (visibleFiles.length === 0) {
                elements.fileList.innerHTML = '<div class="empty-state">暂无照片</div>';
                elements.emptyState.style.display = 'block';
                return;
            }
            
            elements.emptyState.style.display = 'none';
            
            elements.fileList.innerHTML = visibleFiles.map((fileData) => {
                const errorInfo = fileData.error ? 
                    `<div style="color: #dc3545; font-size: 12px; margin-top: 6px;">错误: ${fileData.error}</div>` : '';
                
                // 时间信息显示
                const timeInfo = fileData.fileInfo.hasTime ? 
                    `<div class="file-meta">📅 ${new Date(fileData.fileInfo.earliestTime).toLocaleDateString()}</div>` : 
                    `<div class="file-meta">⏰ 无时间信息</div>`;
                
                // GPS信息显示 - 更详细
                let gpsInfo = '';
                if (fileData.fileInfo.hasGPS) {
                    if (fileData.fileInfo.latitude && fileData.fileInfo.longitude) {
                        gpsInfo = `<div class="file-meta">📍 GPS: ${fileData.fileInfo.latitude.toFixed(6)}, ${fileData.fileInfo.longitude.toFixed(6)}</div>`;
                    } else {
                        gpsInfo = `<div class="file-meta">📍 有GPS数据但无法解析</div>`;
                    }
                } else {
                    gpsInfo = `<div class="file-meta">📍 无GPS信息</div>`;
                }
                
                // 文件大小
                const sizeInfo = `<div class="file-meta">📦 ${formatFileSize(fileData.file.size)}</div>`;
                
                // 取消按钮
                const cancelButton = (fileData.status === 'uploading' || fileData.status === 'pending') ? 
                    `<button class="cancel-btn" data-filename="${fileData.file.name}" title="取消上传">❌</button>` : '';
                
                // 进度条
                const progressBar = (fileData.status === 'uploading' || fileData.status === 'pending') ? 
                    `<div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${fileData.progress}%"></div>
                        </div>
                        <div class="progress-text">${fileData.progress}%</div>
                    </div>` : '';
                
                return `
                <div class="file-item">
                    <div class="file-icon">🖼️</div>
                    <div class="file-info">
                        <div class="file-name">${fileData.file.name}</div>
                        ${timeInfo}
                        ${gpsInfo}
                        ${sizeInfo}
                        ${errorInfo}
                        ${progressBar}
                    </div>
                    <div class="file-actions">
                        <div class="file-status status-${fileData.status}">
                            ${getStatusText(fileData.status)}
                        </div>
                        ${cancelButton}
                    </div>
                </div>
                `;
            }).join('');
            
            attachCancelButtonListeners();
        }

        // 其余函数保持不变...
        // [保持原有的 updateStats, attachCancelButtonListeners, cancelFileUpload, formatFileSize, updateUploadButton, getStatusText, startUpload, continueUpload, uploadFile, generateFileFingerprint, readChunkAsBase64, callCloudFunction, checkServiceStatus, clearFiles, showResult, setupDragAndDrop 函数]

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
